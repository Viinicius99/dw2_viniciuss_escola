<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Cadastro Aluno</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; }
        .test-section { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 8px; }
        .success { background-color: #d4edda; color: #155724; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .info { background-color: #d1ecf1; color: #0c5460; padding: 10px; border-radius: 4px; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .form-row { margin: 10px 0; }
        label { display: inline-block; width: 150px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>üêõ Debug - Cadastro de Aluno</h1>
    
    <div class="test-section">
        <h3>1Ô∏è‚É£ Teste de Conectividade</h3>
        <button onclick="testConnection()">Testar Conex√£o Backend</button>
        <div id="connectionResult"></div>
    </div>
    
    <div class="test-section">
        <h3>2Ô∏è‚É£ Teste de API - Listar Alunos</h3>
        <button onclick="testListStudents()">Carregar Lista de Alunos</button>
        <div id="listResult"></div>
    </div>
    
    <div class="test-section">
        <h3>3Ô∏è‚É£ Teste de API - Criar Aluno</h3>
        <div class="form-row">
            <label>Nome:</label>
            <input type="text" id="testNome" value="Debug Teste">
        </div>
        <div class="form-row">
            <label>Data Nascimento:</label>
            <input type="date" id="testData" value="2010-01-01">
        </div>
        <div class="form-row">
            <label>Email:</label>
            <input type="email" id="testEmail" value="debug@teste.com">
        </div>
        <div class="form-row">
            <label>Status:</label>
            <select id="testStatus">
                <option value="ativo">Ativo</option>
                <option value="inativo">Inativo</option>
            </select>
        </div>
        <div class="form-row">
            <label>Turma ID:</label>
            <input type="number" id="testTurma" value="1" min="1">
        </div>
        <button onclick="testCreateStudent()">Criar Aluno via API</button>
        <div id="createResult"></div>
    </div>
    
    <div class="test-section">
        <h3>4Ô∏è‚É£ Teste do Script Original</h3>
        <p>Este teste usa as mesmas fun√ß√µes do script.js original:</p>
        <button onclick="testOriginalScript()">Testar Fun√ß√£o Original</button>
        <div id="originalResult"></div>
    </div>
    
    <div class="test-section">
        <h3>üìù Log Detalhado</h3>
        <button onclick="clearLog()">Limpar Log</button>
        <div class="log" id="debugLog"></div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8005';
        
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        function clearLog() {
            document.getElementById('debugLog').textContent = '';
        }
        
        async function testConnection() {
            log('=== TESTE DE CONECTIVIDADE ===');
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Conex√£o OK: ${JSON.stringify(data)}`);
                    showResult('connectionResult', `‚úÖ Backend conectado! Status: ${data.status}`, 'success');
                } else {
                    log(`‚ùå Erro HTTP: ${response.status} ${response.statusText}`);
                    showResult('connectionResult', `‚ùå Erro: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro de rede: ${error.message}`);
                showResult('connectionResult', `‚ùå Erro de conex√£o: ${error.message}`, 'error');
            }
        }
        
        async function testListStudents() {
            log('=== TESTE LISTAR ALUNOS ===');
            try {
                const response = await fetch(`${API_BASE}/alunos`);
                if (response.ok) {
                    const students = await response.json();
                    log(`‚úÖ ${students.length} alunos carregados`);
                    showResult('listResult', `‚úÖ ${students.length} alunos encontrados`, 'success');
                    
                    // Mostrar os √∫ltimos 3 alunos
                    const last3 = students.slice(-3);
                    log(`√öltimos 3 alunos: ${JSON.stringify(last3, null, 2)}`);
                } else {
                    log(`‚ùå Erro ao listar: ${response.status} ${response.statusText}`);
                    showResult('listResult', `‚ùå Erro: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`);
                showResult('listResult', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        async function testCreateStudent() {
            log('=== TESTE CRIAR ALUNO ===');
            
            const formData = {
                nome: document.getElementById('testNome').value,
                data_nascimento: document.getElementById('testData').value,
                email: document.getElementById('testEmail').value || null,
                status: document.getElementById('testStatus').value,
                turma_id: parseInt(document.getElementById('testTurma').value) || null
            };
            
            log(`Dados: ${JSON.stringify(formData, null, 2)}`);
            
            try {
                const response = await fetch(`${API_BASE}/alunos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                log(`Status resposta: ${response.status} ${response.statusText}`);
                log(`Headers: ${JSON.stringify(Object.fromEntries(response.headers.entries()), null, 2)}`);
                
                const responseText = await response.text();
                log(`Resposta (texto): ${responseText}`);
                
                if (response.ok) {
                    const result = JSON.parse(responseText);
                    log(`‚úÖ Aluno criado! ID: ${result.id}`);
                    showResult('createResult', `‚úÖ Aluno criado com sucesso! ID: ${result.id}`, 'success');
                } else {
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                    } catch {
                        errorData = { message: responseText };
                    }
                    
                    const errorMsg = errorData.detail || errorData.message || `Erro ${response.status}`;
                    log(`‚ùå Erro: ${errorMsg}`);
                    showResult('createResult', `‚ùå Erro: ${errorMsg}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro de rede: ${error.message}`);
                log(`Stack: ${error.stack}`);
                showResult('createResult', `‚ùå Erro: ${error.message}`, 'error');
            }
        }
        
        // Fun√ß√µes do script original para teste
        function buildUrl(path) {
            const API_URL = localStorage.getItem('API_URL') || 'http://127.0.0.1:8005';
            const base = String(API_URL || '');
            const p = String(path || '/');
            if (!base) {
                return p.startsWith('/') ? p : `/${p}`;
            }
            const trimmedBase = base.replace(/\/$/, '');
            return p.startsWith('/') ? `${trimmedBase}${p}` : `${trimmedBase}/${p}`;
        }
        
        async function fetchWithoutAuth(path, options = {}) {
            const res = await fetch(buildUrl(path), {
                headers: { 'Content-Type': 'application/json', ...(options.headers || {}) },
                ...options,
            });
            
            const isJSON = res.headers.get('content-type')?.includes('application/json');
            const data = isJSON ? await res.json() : null;
            
            if (!res.ok) {
                const msg = data?.detail || data?.message || `Erro ${res.status}`;
                throw new Error(msg);
            }
            return data;
        }
        
        function mapAlunoFormToBack(form) {
            return {
                nome: form.name,
                data_nascimento: form.birthDate,
                email: form.email || null,
                status: form.status,
                turma_id: form.classId || null,
            };
        }
        
        function mapAlunoOutToFront(a) {
            return {
                id: a.id,
                name: a.nome,
                birthDate: a.data_nascimento,
                email: a.email || null,
                status: a.status,
                classId: a.turma_id || null,
            };
        }
        
        async function createAlunoApi(form) {
            const payload = mapAlunoFormToBack(form);
            const data = await fetchWithoutAuth('/alunos', { method: 'POST', body: JSON.stringify(payload) });
            return mapAlunoOutToFront(data);
        }
        
        async function testOriginalScript() {
            log('=== TESTE SCRIPT ORIGINAL ===');
            
            // Simular dados do formul√°rio como no script original
            const formData = {
                name: 'Teste Script Original',
                birthDate: '2010-01-01',
                email: 'original@teste.com',
                status: 'ativo',
                classId: 1
            };
            
            log(`Dados form frontend: ${JSON.stringify(formData, null, 2)}`);
            
            try {
                // Usar as fun√ß√µes exatas do script.js
                const result = await createAlunoApi(formData);
                log(`‚úÖ Resultado createAlunoApi: ${JSON.stringify(result, null, 2)}`);
                showResult('originalResult', `‚úÖ Script original funcionou! ID: ${result.id}`, 'success');
            } catch (error) {
                log(`‚ùå Erro no script original: ${error.message}`);
                log(`Stack: ${error.stack}`);
                showResult('originalResult', `‚ùå Erro no script: ${error.message}`, 'error');
            }
        }
        
        // Auto-testar conectividade ao carregar
        window.addEventListener('load', () => {
            log('=== P√ÅGINA CARREGADA ===');
            testConnection();
        });
    </script>
</body>
</html>